<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>运动记录生成器</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.1.3/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
<div id="app" class="max-w-sm md:max-w-2xl mx-auto mt-4 md:mt-8 p-4 md:p-6 bg-white rounded-lg shadow">
    <h1 class="text-xl md:text-2xl font-bold mb-4 text-blue-700">运动记录生成器</h1>

    <div v-if="exercises.length" class="mb-6">
        <h2 class="text-lg font-semibold mb-3">运动项目</h2>
        <div v-for="ex in exercises" :key="ex.name" class="mb-2 flex flex-col md:flex-row md:items-center gap-2">
            <label class="flex-1 text-sm md:text-base">${ex.name} (强度: ${ex.intensity})</label>
            <input type="number" v-model="inputs[ex.name]" min="0" class="w-full md:w-20 px-2 py-1 border rounded" placeholder="数量">
        </div>
    </div>

    <div class="mb-4">
        <label class="block mb-2 font-semibold">体感评分</label>
        <div class="flex gap-1">
            <span v-for="i in 5" :key="i" @click="rating = i" class="cursor-pointer text-2xl" :class="i <= rating ? 'text-yellow-400' : 'text-gray-300'">★</span>
        </div>
    </div>

    <div class="mb-4">
        <label class="block mb-2 font-semibold">用时 (分钟)</label>
        <input type="number" v-model="duration" min="0" class="w-full md:w-20 px-2 py-1 border rounded" placeholder="分钟">
    </div>

    <div class="mb-4">
        <label class="block mb-2 font-semibold">备注</label>
        <input v-model="remark" class="w-full px-2 py-1 border rounded" placeholder="可选备注">
    </div>

    <button @click="generateRecord" class="w-full md:w-auto px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">生成记录</button>

    <div v-if="generatedRecord" class="mt-6 p-4 bg-gray-100 rounded">
        <h3 class="font-semibold mb-2">生成的记录字符串</h3>
        <textarea readonly rows="4" class="w-full border rounded p-2 whitespace-pre-line">${generatedRecord}</textarea>
        <button @click="copyRecord" class="mt-2 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">复制文本</button>
    </div>

    <div v-if="error" class="text-red-500 mt-2">${error}</div>
</div>

<script>
const { createApp } = Vue;
createApp({
    delimiters: ['${', '}'],
    data() {
        return {
            exercises: [],
            inputs: {},
            rating: 3,
            duration: '',
            remark: '',
            generatedRecord: '',
            error: ''
        }
    },
    mounted() {
        // 尝试从后端拉取；若失败，使用内置默认项目，保证静态部署也能工作
        axios.get('/api/fitness/exercises').then(res => {
            this.exercises = res.data.exercises || this.defaultExercises();
        }).catch(() => {
            this.error = 'Failed to load remote exercises; using built-in default list';
            this.exercises = this.defaultExercises();
        });
    },
    methods: {
        defaultExercises() {
            return [
                { name: '双力臂', intensity: 6 },
                { name: '20s慢上慢下引体', intensity: 6 },
                { name: '标准引体', intensity: 1 },
                { name: '悬垂举腿碰杆悬停3s', intensity: 4 },
                { name: '悬垂举腿碰杆（标准）', intensity: 2 },
                { name: '双杠臂屈伸（双手离杠）', intensity: 4 }
            ];
        },
        generateRecord() {
            this.error = '';
            const today = new Date();
            const dateStr = today.getFullYear().toString().slice(-2) + '.' + 
                           (today.getMonth() + 1).toString().padStart(2, '0') + '.' + 
                           today.getDate().toString().padStart(2, '0') + ' ' +
                           today.getHours().toString().padStart(2, '0') + ':' +
                           today.getMinutes().toString().padStart(2, '0');

            let record = dateStr + '\n';
            let totalIntensity = 0;
            let hasExercises = false;

            for (const ex of this.exercises) {
                const count = parseInt(this.inputs[ex.name]) || 0;
                if (count > 0) {
                    record += `${ex.name}${count} `;
                    totalIntensity += count * ex.intensity;
                    hasExercises = true;
                }
            }

            if (hasExercises) {
                record = record.trim() + '\n';
            }

            if (totalIntensity > 0) {
                record += `综合强度${Math.round(totalIntensity)}\n`;
            }

            record += `体感评分${'★'.repeat(this.rating)}\n`;

            if (this.duration) {
                record += `用时${this.duration}分钟\n`;
            }

            if (this.remark.trim()) {
                record += `备注 ${this.remark}`;
            }

            this.generatedRecord = record.trim();
        },
        async copyRecord() {
            try {
                await navigator.clipboard.writeText(this.generatedRecord);
                alert('Copied to clipboard');
            } catch (err) {
                console.error('Copy failed:', err);
                const textarea = document.createElement('textarea');
                textarea.value = this.generatedRecord;
                textarea.style.position = 'fixed';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    const success = document.execCommand('copy');
                    if (success) {
                        console.log('Copied to clipboard (fallback)');
                    } else {
                        alert('Copy failed, please copy manually');
                    }
                } catch (e) {
                    alert('Copy failed, please copy manually');
                }
                document.body.removeChild(textarea);
            }
        }
    }
}).mount('#app');
</script>
</body>
</html>